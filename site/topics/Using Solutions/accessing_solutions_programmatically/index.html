<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>Accessing Programmatically - SoFy Docs</title>
        <link href="../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../..">SoFy Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../.." class="nav-link">Welcome</a>
                            </li>
                            <li class="navitem">
                                <a href="../../../about/" class="nav-link">About</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Topics <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Installing Solutions</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../Installing%20Solutions/" class="dropdown-item">Installing Solutions</a>
</li>
            
<li>
    <a href="../../Installing%20Solutions/using_new_gcp_trial_account/" class="dropdown-item">Quick Start - GCP Trial</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Kubernetes Administration</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../Installing%20Solutions/Kubernetes%20Administration/" class="dropdown-item">Kubernetes Administration</a>
</li>
            
<li>
    <a href="../../Installing%20Solutions/Kubernetes%20Administration/applying_your_own_domain_name_and_ssl_cert/" class="dropdown-item">Domains & Certificates</a>
</li>
            
<li>
    <a href="../../Installing%20Solutions/Kubernetes%20Administration/installing_solutions_step_by_step_instructions/" class="dropdown-item">Install Step-By-Step</a>
</li>
            
<li>
    <a href="../../Installing%20Solutions/Kubernetes%20Administration/setting_up_flexnet/" class="dropdown-item">FlexNet Licensing</a>
</li>
            
<li>
    <a href="../../Installing%20Solutions/Kubernetes%20Administration/supported_kubernetes_environments/" class="dropdown-item">Supported Environments</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Solution Overview</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../Solution%20Overview/" class="dropdown-item">Solution Overview</a>
</li>
            
<li>
    <a href="../../Solution%20Overview/sofy_common_services/" class="dropdown-item">SoFy Common Services</a>
</li>
            
<li>
    <a href="../../Solution%20Overview/solution-overview/" class="dropdown-item">What is a Solution?</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Using Solutions</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../" class="dropdown-item">Using Solutions</a>
</li>
            
<li>
    <a href="./" class="dropdown-item active">Accessing Programmatically</a>
</li>
            
<li>
    <a href="../default_login_credentials/" class="dropdown-item">Default Credentials</a>
</li>
            
<li>
    <a href="../managing_solution_users/" class="dropdown-item">Managing User Access</a>
</li>
            
<li>
    <a href="../sofy_software_offerings/" class="dropdown-item">Software Offerings</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../default_login_credentials/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#accessing-solutions-programmatically" class="nav-link">Accessing Solutions Programmatically</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#discovering-rest-api-documentation-for-sofy-catalog-services" class="nav-link">Discovering REST API Documentation for SoFy Catalog Services</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#discovering-rest-api-base-urls-in-deployed-solutions" class="nav-link">Discovering REST API Base URLs in Deployed Solutions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#handling-self-signed-certificates" class="nav-link">Handling Self-Signed Certificates</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="accessing-solutions-programmatically"><strong>Accessing Solutions Programmatically</strong></h1>
<p>Many of the SoFy Catalog services in a solution contain REST APIs, which are simple to use in client applications. The code examples shown below are written in Java, using the HTTP Client that was new in Java version 11 (java.net.http.HttpClient), but with REST you can choose from many programming languages and REST libraries for your application.</p>
<h2 id="discovering-rest-api-documentation-for-sofy-catalog-services">Discovering REST API Documentation for SoFy Catalog Services</h2>
<p>There are two ways to discover the REST APIs provided by SoFy Catalog services and products. Both rely on the API being documented using the Swagger v2 or OpenAPI v3 standard:</p>
<ul>
<li>
<p><strong>SoFy Catalog</strong></p>
<ul>
<li>Click on a catalog card to view its documentation. The <em>API Documentation</em> tab will contain available REST API documentation. 
In the catalog, this is simply a rendering of the documentation; there is no live instance of the service available, so the REST API method cannot be run in this environment. The documentation is provided as reference for your application coding.</li>
</ul>
</li>
<li>
<p><strong>Swagger UIs in Deployed Solutions</strong></p>
<ul>
<li>In some cases, a live Swagger or OpenAPI UI is available within a service or product once it is deployed in an installed solution. Links to these UIs are shown in the Solution Console in the <em>General Information</em> for each entry, under the <em>API Explorer</em> tag. </li>
</ul>
</li>
</ul>
<h2 id="discovering-rest-api-base-urls-in-deployed-solutions">Discovering REST API Base URLs in Deployed Solutions</h2>
<p>REST API base URLs are displayed in the Solution Console, in the <em>General Information</em> for each entry, under the <em>API BASE</em> tag.</p>
<h2 id="handling-self-signed-certificates">Handling Self-Signed Certificates</h2>
<p>By default, SoFy generates a self-signed SSL/TLS certificate for each solution. For production use, it is recommended that you override this with a certificate generated for your own domain name. In development, you may choose to operate with the provided certificate.  </p>
<p>In Java applications, one approach to self-signed certificates is to override the default trust manager with one that does not validate certificate chains:
 ```
import java.net.http.HttpClient;
import java.security.GeneralSecurityException;
import java.security.cert.X509Certificate;
import javax.net.ssl.SSLContext;
import javax.net.ssl.TrustManager;
import javax.net.ssl.X509TrustManager;</p>
<p>...</p>
<pre><code>    // Create a trust manager that does not validate certificate chains
    TrustManager[] trustAllCerts = new TrustManager[] {
            new X509TrustManager() {     
                public java.security.cert.X509Certificate[] getAcceptedIssuers() {
                    return new X509Certificate[0];
                }
                public void checkClientTrusted(
                        java.security.cert.X509Certificate[] certs, String authType) {
                }
                public void checkServerTrusted(
                        java.security.cert.X509Certificate[] certs, String authType) {
                }
            }
    };

    // Create the all-trusting trust manager
    SSLContext sc = null;
    try {
        sc = SSLContext.getInstance("SSL");
        sc.init(null, trustAllCerts, new java.security.SecureRandom());
    } catch (GeneralSecurityException e) {
    }

    // Also need to tell the client to not compare request host names with the certificate content
    final Properties props = System.getProperties();
    props.setProperty("jdk.internal.httpclient.disableHostnameVerification", Boolean.TRUE.toString());

    // set the all-trusting trust manager on the client builder
    HttpClient.Builder builder = HttpClient.newBuilder();
    builder.sslContext(sc);

    // Create HTTP Client to send requests to solution services
    HttpClient sol_client = builder
            .version(Version.HTTP_1_1)
            .build();
</code></pre>
<pre><code>
## Authenticate to Obtain a JSON Web Token (JWT)
If the Access Control Service (ACS) is included in the solution, you first need to authenticate to ACS and then receive a JWT to include on any subsequent API call. Authentication is achieved through a GET request to the *h&lt;span&gt;ttps://sofy-auth.{external.ip}.nip.io/login* endpoint using the HTTP Basic authentication protocol.

There are two User IDs (userids) that are created for every solution and you can add more User IDs if you wish.

| Userid            | Default password          | Access |
| ----------- | ----------- | ----------- |
| user              | pass                      | catalog services |
| sol-admin         | pass                      | all services (including Solution Console)|

To access Solution Console, use the *sol-admin* administrator id.

The User ID (userid) and password must be Base64 encoded and included in the **Authorization** HTTP header, as shown in the example below:

</code></pre>
<pre><code>    String idpw = "user:pass";
    String encodedString = Base64.getEncoder().encodeToString(idpw.getBytes());
    // replace with your own solution's external ip address
    ext_ip = "34.67.88.109.nip.io";

    HttpResponse response = null;
    try {
        String url = "https://sofy-auth." + ext_ip + "/login";

        HttpRequest request = HttpRequest.newBuilder()
                .uri(URI.create(url))
                .GET()
                .timeout(Duration.ofSeconds(150))
                .header("accept", "application/json")
                .header("Authorization", "Basic "+encodedString)
                .build();

        // Send a request using the HTTPClient that was created with the all-trusting trust manager
        response = sol_client.send(request, BodyHandlers.ofString());

        switch (response.statusCode()) {
        case (200):
            // Success - extract JWT from Auth header and save it for future requests
            HttpHeaders headers = response.headers();
            List&lt;String&gt; auths = headers.allValues("Authorization");
            // Header requires 'Bearer' before actual token value
            token = "Bearer "+(String)response.body();
            // You may want to persist the token at this point                          
            break;
        case (404):
            System.out.println("sofy-auth login not found, perhaps ACS not included in this solution");
            break;
        case (500):
            // Workaround: ACS may take a short time to complete initialization
            System.out.println("sofy-auth login returned 500, will retry once after a short pause");
            Thread.sleep(60000);
            loginToSolution(idpw, soldomain);
            break;
        default:
            System.out.println("sofy-auth login failed: "+response.statusCode());
            System.out.println(response.body());
        }
    }catch(Exception e) {
        e.printStackTrace();
    }
</code></pre>
<pre><code>
The JWT will be valid for 5 minutes and then will expire, after which re-authentication will be necessary. If you wish to query the expiry time of the token, the code below shows how to do that using the Auth0 java-jwt library.  

</code></pre>
<p>import com.auth0.jwt.JWT;
import com.auth0.jwt.exceptions.JWTDecodeException;
import com.auth0.jwt.interfaces.DecodedJWT;
...
        DecodedJWT jwt = null;
        String jwtString = token.replace("Bearer ","");</p>
<pre><code>    try {                   
        jwt = JWT.decode(jwtString);

        Date expiryTime = jwt.getExpiresAt();
        Date now = new Date();
        System.out.println("token expires at: "+expiryTime);
        System.out.println("time now is: "+now);
        tokenExpired = now.after(expiryTime);
        if (tokenExpired)
             System.out.println("Token for solution access is already expired - expect 401/403 the re-authentication");
             // Could choose to re-login here, but an unexpired token may still expire between this point and the next API call         
        } catch (JWTDecodeException exception){
             System.out.println("JWT decode failed for token: "+jwtString);
             exception.printStackTrace();
        }
</code></pre>
<pre><code>## Call the Catalog Service REST API

Once you have the URL for the REST method you want to call, an HTTP client that will handle self-signed certificates (unless you have applied your own domain/certificate), and the authorization token (if ACS is used in your solution), then you are ready to make a call to a catalog service REST API.

There are a couple of workarounds shown in the example below, with a counter to limit the retry attempts.
</code></pre>
<pre><code>private static void callApi() {
    HttpResponse response = null;
    apiCallCounter++;

    if (apiCallCounter &gt; apiCallRetryLimit) {
        System.out.println("Reached max attempts to call solution REST API, giving up");
        return;
    }
    boolean tokenExpired = false;

    try {
        String url = "https://test-data-synth." + ext_ip + "/datasynth/1.0/data/ccVisa?count=5";

        HttpRequest.Builder builder = HttpRequest.newBuilder();
        if (acs) {
            builder.header("Authorization", token);  // be careful not to add null token (-&gt; NPE)
        HttpRequest request = builder
                .uri(URI.create(url))
                .GET()
                .timeout(Duration.ofSeconds(90))
                .header("accept", "application/json")
                .build();

        response =
                sol_client.send(request, BodyHandlers.ofString());
        switch (response.statusCode()) {
        case (200):
            System.out.println("tds GET returned 200");
            JSONArray testDataJson = new JSONArray((String)response.body());
            System.out.println(testDataJson.toString(4));
            break;
        case (307):
            System.out.println("*** RC 307 Redirect - suggests protected method was called without auth header data");
            break;
        case (401):
        case (403):
            System.out.println("*** Authentication/Authorization issue, RC: "+response.statusCode());
            System.out.println("May be token expiry, re-authenticate (once) and retry");
            // call method with login logic shown above
            loginToSolution("user:pass", ext_ip);
            apiCallCounter = apiCallRetryLimit -1;
            callApi();
            break;
        case (404):
            System.out.println("*** 404: tds records not found... service may not be included or not running");
            break;
        case (503):
            System.out.println("*** 503 returned - wait 5 seconds then try again");
            Thread.sleep(5000);
            callApi();
        break;
        default:
            System.out.println("*** tds home access failed: "+response.statusCode());
            System.out.println("response body: "+response.body());
            System.out.println("response headers:: "+response.headers());
        }

    }catch(Exception e) {
        e.printStackTrace();
    }
}
</code></pre>
<p>```</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js" defer></script>
        <script src="../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
